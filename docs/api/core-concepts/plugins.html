<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plugins - jaato docs</title>
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="../index.html" class="header-logo">
      jaato <span>docs</span>
    </a>
    <nav class="header-nav">
      <a href="../getting-started/quickstart.html">Quickstart</a>
      <a href="../api-reference/index.html">API Reference</a>
      <a href="https://github.com/apanoia/jaato" target="_blank">GitHub</a>
      <div class="header-search">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" placeholder="Search docs... (press /)">
      </div>
    </nav>
  </header>

  <!-- Layout -->
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Getting Started</div>
        <ul class="sidebar-nav">
          <li><a href="../getting-started/quickstart.html">Quickstart</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Core Concepts</div>
        <ul class="sidebar-nav">
          <li><a href="client.html">Client</a></li>
          <li><a href="plugins.html" class="active">Plugins</a></li>
          <li><a href="tools.html">Tools</a></li>
          <li><a href="providers.html">Providers</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Guides</div>
        <ul class="sidebar-nav">
          <li><a href="../guides/tool-plugins.html">Building Plugins</a></li>
          <li><a href="../guides/mcp-integration.html">MCP Integration</a></li>
          <li><a href="../guides/permissions.html">Permissions</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">API Reference</div>
        <ul class="sidebar-nav">
          <li><a href="../api-reference/index.html">Overview</a></li>
          <li><a href="../api-reference/jaato-client.html">JaatoClient</a></li>
          <li><a href="../api-reference/plugin-registry.html">PluginRegistry</a></li>
          <li><a href="../api-reference/types.html">Types</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Provider Reference</div>
        <ul class="sidebar-nav">
          <li><a href="../api-reference/providers/index.html">Overview</a></li>
          <li><a href="../api-reference/providers/google-genai.html">Google GenAI</a></li>
        </ul>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main">
      <!-- Introduction -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h1>Plugins</h1>
          <p class="lead">
            Plugins are the extension mechanism of jaato. They provide tools,
            garbage collection strategies, and model provider implementations.
          </p>

          <h2 id="plugin-types">Plugin Types</h2>
          <p>
            jaato has three categories of plugins:
          </p>

          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Purpose</th>
                <th>Examples</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Tool</strong></td>
                <td>Provide capabilities the model can invoke</td>
                <td>cli, mcp, file_edit, todo</td>
              </tr>
              <tr>
                <td><strong>GC</strong></td>
                <td>Manage context window limits</td>
                <td>gc_truncate, gc_summarize</td>
              </tr>
              <tr>
                <td><strong>Provider</strong></td>
                <td>Connect to AI services</td>
                <td>google_genai</td>
              </tr>
            </tbody>
          </table>

          <p>
            This page focuses on <strong>Tool Plugins</strong>, which are the
            most common type you'll work with.
          </p>
        </div>
        <div class="panel-code">
          <div class="code-label">Plugin discovery</div>
          <div class="code-block">
            <pre><code class="language-python">from shared import PluginRegistry

registry = PluginRegistry(model_name="gemini-2.5-flash")

# Discover each type
tools = registry.discover(plugin_kind="tool")
gc = registry.discover(plugin_kind="gc")
providers = registry.discover(plugin_kind="model_provider")

print(f"Tool plugins: {tools}")
print(f"GC plugins: {gc}")
print(f"Providers: {providers}")</code></pre>
          </div>
        </div>
      </section>

      <!-- Registry vs Direct Configuration -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="registry-vs-direct">Registry vs Direct Configuration</h2>
          <p>
            Not all plugins are managed through the <code>PluginRegistry</code>.
            There's an important distinction:
          </p>

          <table>
            <thead>
              <tr>
                <th>Management</th>
                <th>Plugin Types</th>
                <th>How to Enable</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Registry</strong></td>
                <td>Tool plugins</td>
                <td><code>registry.expose_tool()</code></td>
              </tr>
              <tr>
                <td><strong>Client</strong></td>
                <td>GC, Session, Permission</td>
                <td><code>client.set_*_plugin()</code></td>
              </tr>
              <tr>
                <td><strong>Constructor</strong></td>
                <td>Model Providers</td>
                <td><code>JaatoClient(provider_name=)</code></td>
              </tr>
            </tbody>
          </table>

          <h3>Why the Difference?</h3>
          <p>
            Tool plugins provide capabilities to the model and can be mixed
            and matched freely. GC, session, and permission plugins affect
            client behavior directly and require explicit configuration.
          </p>

          <div class="callout callout-warning">
            <div class="callout-title">Common Mistake</div>
            Don't look for GC or session plugins in the registry's
            <code>list_available()</code>. They need to be created and
            attached to the client directly.
          </div>
        </div>
        <div class="panel-code">
          <div class="code-label">Tool plugins (via registry)</div>
          <div class="code-block">
            <pre><code class="language-python"># Tool plugins: discover → expose → configure
registry = PluginRegistry(model_name="gemini-2.5-flash")
registry.discover()
registry.expose_tool("cli")
registry.expose_tool("file_edit")

client.configure_tools(registry)</code></pre>
          </div>

          <div class="code-label" style="margin-top: 24px;">Other plugins (direct on client)</div>
          <div class="code-block">
            <pre><code class="language-python"># GC plugin: create → initialize → set
from shared.plugins.gc_truncate import create_plugin

gc = create_plugin()
gc.initialize({"preserve_recent_turns": 5})
client.set_gc_plugin(gc)

# Session plugin: create → initialize → set
from shared.plugins.session import create_plugin

session = create_plugin()
session.initialize({"storage_path": ".sessions"})
client.set_session_plugin(session)

# Permission plugin: passed to configure_tools
from shared import PermissionPlugin

perm = PermissionPlugin()
perm.initialize({"config_path": "perms.json"})
client.configure_tools(registry, permission_plugin=perm)</code></pre>
          </div>

          <div class="code-label" style="margin-top: 24px;">Provider (at construction)</div>
          <div class="code-block">
            <pre><code class="language-python"># Provider selected when creating client
client = JaatoClient(provider_name="google_genai")

# Cannot be changed after construction
# Create a new client for different provider</code></pre>
          </div>
        </div>
      </section>

      <!-- Plugin Discovery -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="discovery">Plugin Discovery</h2>
          <p>
            Plugins are discovered via two mechanisms:
          </p>

          <table>
            <thead>
              <tr>
                <th>Method</th>
                <th>Use Case</th>
                <th>Location</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Entry Points</strong></td>
                <td>External packages, production</td>
                <td><code>pyproject.toml</code></td>
              </tr>
              <tr>
                <td><strong>Directory</strong></td>
                <td>Built-ins, development</td>
                <td><code>shared/plugins/</code></td>
              </tr>
            </tbody>
          </table>

          <h3>Entry Points (Recommended)</h3>
          <p>
            External packages register plugins via Python entry points in
            <code>pyproject.toml</code>. This is the recommended approach for
            distributing plugins.
          </p>

          <h3>Directory Scanning</h3>
          <p>
            For development and built-in plugins, the registry scans
            <code>shared/plugins/</code> for modules with a
            <code>create_plugin()</code> factory function.
          </p>
        </div>
        <div class="panel-code">
          <div class="code-label">pyproject.toml entry point</div>
          <div class="code-block">
            <pre><code class="language-python"># In pyproject.toml of external package
[project.entry-points."jaato.plugins"]
my_plugin = "my_package.plugins:create_plugin"

# The entry point must reference a factory function
# that returns a ToolPlugin instance</code></pre>
          </div>

          <div class="code-label" style="margin-top: 24px;">Discovery options</div>
          <div class="code-block">
            <pre><code class="language-python">from shared import PluginRegistry

registry = PluginRegistry()

# Both entry points + directory (default)
registry.discover()

# Entry points only (installed packages)
registry.discover(include_directory=False)

# Check what was found
print(registry.list_available())
# ['cli', 'mcp', 'my_plugin', ...]</code></pre>
          </div>
        </div>
      </section>

      <!-- Plugin Registry -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="registry">The Plugin Registry</h2>
          <p>
            The <code>PluginRegistry</code> is the central manager for tool plugins.
            It handles discovery, registration, and exposure.
          </p>

          <h3>Key Concepts</h3>
          <table>
            <thead>
              <tr>
                <th>Term</th>
                <th>Meaning</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Discovered</strong></td>
                <td>Found and available for use</td>
              </tr>
              <tr>
                <td><strong>Registered</strong></td>
                <td>Loaded into the registry</td>
              </tr>
              <tr>
                <td><strong>Exposed</strong></td>
                <td>Tools are available to the model</td>
              </tr>
            </tbody>
          </table>

          <p>
            Discovery finds plugins, but they're not active until exposed.
            This gives you control over what capabilities the model has.
          </p>

          <div class="callout callout-info">
            <div class="callout-title">Why Expose?</div>
            Separating discovery from exposure lets you inspect available
            plugins before deciding which to enable. You might want different
            tools for different tasks.
          </div>
        </div>
        <div class="panel-code">
          <div class="code-label">Registry workflow</div>
          <div class="code-block">
            <pre><code class="language-python">from shared import PluginRegistry

registry = PluginRegistry(model_name="gemini-2.5-flash")

# Step 1: Discover what's available
registry.discover()
print(f"Available: {registry.list_available()}")
# ['cli', 'mcp', 'file_edit', 'todo', ...]

# Step 2: Expose what you need
registry.expose_tool("cli")
registry.expose_tool("file_edit")

print(f"Exposed: {registry.list_exposed()}")
# ['cli', 'file_edit']

# Step 3: Check if specific plugin is exposed
if registry.is_exposed("cli"):
    print("CLI tools are active")

# Step 4: Get tools for the client
schemas = registry.get_exposed_tool_schemas()
executors = registry.get_exposed_executors()</code></pre>
          </div>
        </div>
      </section>

      <!-- Built-in Plugins -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="built-in">Built-in Tool Plugins</h2>
          <p>
            jaato includes several tool plugins out of the box:
          </p>

          <h3>cli</h3>
          <p>
            Execute shell commands. Supports auto-backgrounding for long-running
            commands.
          </p>

          <h3>mcp</h3>
          <p>
            Connect to Model Context Protocol servers. Auto-discovers tools from
            MCP servers defined in <code>.mcp.json</code>.
          </p>

          <h3>file_edit</h3>
          <p>
            Read, write, and edit files. Supports diff-based editing for
            precise changes.
          </p>

          <h3>todo</h3>
          <p>
            Manage task lists. Persistent storage with filtering and status
            tracking.
          </p>

          <h3>web_search</h3>
          <p>
            Search the web. Returns structured search results.
          </p>

          <h3>permission</h3>
          <p>
            Control tool execution permissions. Approve/deny tool calls based
            on rules.
          </p>
        </div>
        <div class="panel-code">
          <div class="code-label">Using built-in plugins</div>
          <div class="code-block">
            <pre><code class="language-python"># Expose with default config
registry.expose_tool("cli")
registry.expose_tool("file_edit")
registry.expose_tool("todo")

# Expose with custom config
registry.expose_tool("cli", config={
    "extra_paths": ["/opt/bin"],
    "max_output_chars": 10000,
    "auto_background_threshold": 5.0
})

# Expose MCP with specific servers
registry.expose_tool("mcp", config={
    "servers": ["Atlassian", "GitHub"]
})

# Expose all at once
registry.expose_all()

# Expose all with per-plugin config
registry.expose_all(config={
    "cli": {"max_output_chars": 5000},
    "todo": {"storage_path": ".tasks.json"}
})</code></pre>
          </div>

          <div class="code-label" style="margin-top: 24px;">Check available tools</div>
          <div class="code-block">
            <pre><code class="language-python"># List tools from exposed plugins
schemas = registry.get_exposed_tool_schemas()

for schema in schemas:
    print(f"{schema.name}")
    print(f"  {schema.description}")
    print()

# Example output:
# execute_command
#   Execute a shell command
#
# read_file
#   Read contents of a file
#
# edit_file
#   Edit a file with diff</code></pre>
          </div>
        </div>
      </section>

      <!-- Plugin Protocol -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="protocol">Tool Plugin Protocol</h2>
          <p>
            Tool plugins implement a simple protocol. At minimum, they provide:
          </p>

          <ul class="param-list">
            <li>
              <span class="param-name">name</span>
              <span class="param-type">str</span>
              <div class="param-desc">Unique identifier for the plugin</div>
            </li>
            <li>
              <span class="param-name">get_tool_schemas()</span>
              <span class="param-type">List[ToolSchema]</span>
              <div class="param-desc">Declare available tools</div>
            </li>
            <li>
              <span class="param-name">get_executors()</span>
              <span class="param-type">Dict[str, Callable]</span>
              <div class="param-desc">Map tool names to functions</div>
            </li>
          </ul>

          <h3>Optional Methods</h3>
          <ul class="param-list">
            <li>
              <span class="param-name">initialize(config)</span>
              <div class="param-desc">Setup with configuration</div>
            </li>
            <li>
              <span class="param-name">shutdown()</span>
              <div class="param-desc">Cleanup resources</div>
            </li>
            <li>
              <span class="param-name">get_system_instructions()</span>
              <div class="param-desc">Add to system prompt</div>
            </li>
            <li>
              <span class="param-name">get_auto_approved_tools()</span>
              <div class="param-desc">Tools that don't need permission</div>
            </li>
            <li>
              <span class="param-name">get_model_requirements()</span>
              <div class="param-desc">Required model patterns</div>
            </li>
          </ul>
        </div>
        <div class="panel-code">
          <div class="code-label">Minimal plugin</div>
          <div class="code-block">
            <pre><code class="language-python">from shared import ToolSchema

class WeatherPlugin:
    name = "weather"

    def get_tool_schemas(self):
        return [
            ToolSchema(
                name="get_weather",
                description="Get weather for a city",
                parameters={
                    "type": "object",
                    "properties": {
                        "city": {"type": "string"}
                    },
                    "required": ["city"]
                }
            )
        ]

    def get_executors(self):
        return {
            "get_weather": self._get_weather
        }

    def _get_weather(self, city: str) -> str:
        # Implementation here
        return f"Weather in {city}: Sunny, 72°F"</code></pre>
          </div>

          <div class="code-label" style="margin-top: 24px;">Full-featured plugin</div>
          <div class="code-block">
            <pre><code class="language-python">class AdvancedPlugin:
    name = "advanced"

    def initialize(self, config):
        self.api_key = config.get("api_key")

    def shutdown(self):
        # Cleanup connections
        pass

    def get_tool_schemas(self):
        return [...]

    def get_executors(self):
        return {...}

    def get_system_instructions(self):
        return "Use advanced_tool for X..."

    def get_auto_approved_tools(self):
        return ["safe_tool"]

    def get_model_requirements(self):
        return ["gemini-*"]  # Gemini only</code></pre>
          </div>
        </div>
      </section>

      <!-- Registration -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="registration">Registering Custom Plugins</h2>
          <p>
            You can register custom plugins manually using
            <code>register_plugin()</code>.
          </p>

          <h3>Parameters</h3>
          <ul class="param-list">
            <li>
              <span class="param-name">plugin</span>
              <span class="param-type">ToolPlugin</span>
              <div class="param-desc">Your plugin instance</div>
            </li>
            <li>
              <span class="param-name">expose</span>
              <span class="param-type">bool</span>
              <div class="param-desc">Expose immediately (default: False)</div>
            </li>
            <li>
              <span class="param-name">enrichment_only</span>
              <span class="param-type">bool</span>
              <div class="param-desc">Only use for prompt enrichment</div>
            </li>
            <li>
              <span class="param-name">config</span>
              <span class="param-type">Dict</span>
              <div class="param-desc">Plugin configuration</div>
            </li>
          </ul>
        </div>
        <div class="panel-code">
          <div class="code-label">Register custom plugin</div>
          <div class="code-block">
            <pre><code class="language-python">from my_plugins import WeatherPlugin

registry = PluginRegistry(model_name="gemini-2.5-flash")
registry.discover()  # Discover built-ins

# Register custom plugin
weather = WeatherPlugin()
registry.register_plugin(
    weather,
    expose=True,
    config={"api_key": "..."}
)

# Now available alongside built-ins
print(registry.list_exposed())
# ['cli', 'weather']</code></pre>
          </div>

          <div class="code-label" style="margin-top: 24px;">Enrichment-only plugin</div>
          <div class="code-block">
            <pre><code class="language-python"># Plugin that modifies prompts but
# doesn't provide tools
class ContextPlugin:
    name = "context"

    def subscribes_to_prompt_enrichment(self):
        return True

    def enrich_prompt(self, prompt):
        cwd = os.getcwd()
        return PromptEnrichmentResult(
            prompt=f"[CWD: {cwd}]\n{prompt}",
            original_prompt=prompt,
            enrichments=["added_cwd"]
        )

    def get_tool_schemas(self):
        return []  # No tools

# Register for enrichment only
registry.register_plugin(
    ContextPlugin(),
    enrichment_only=True
)</code></pre>
          </div>
        </div>
      </section>

      <!-- System Instructions -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="system-instructions">System Instructions</h2>
          <p>
            Plugins can contribute to the system prompt via
            <code>get_system_instructions()</code>. The registry combines
            instructions from all exposed plugins.
          </p>

          <p>
            Use system instructions to:
          </p>
          <ul>
            <li>Explain when to use your tools</li>
            <li>Provide usage guidelines</li>
            <li>Set behavioral constraints</li>
          </ul>

          <div class="callout callout-warning">
            <div class="callout-title">Keep It Concise</div>
            System instructions consume context tokens. Keep them focused
            and avoid redundancy with tool descriptions.
          </div>
        </div>
        <div class="panel-code">
          <div class="code-label">System instructions</div>
          <div class="code-block">
            <pre><code class="language-python">class DatabasePlugin:
    name = "database"

    def get_system_instructions(self):
        return """
When working with the database:
- Always use transactions for writes
- Prefer query_database over raw_sql
- Never expose connection strings
""".strip()

    def get_tool_schemas(self):
        return [
            ToolSchema(
                name="query_database",
                description="Run a safe query",
                parameters={...}
            )
        ]</code></pre>
          </div>

          <div class="code-label" style="margin-top: 24px;">Get combined instructions</div>
          <div class="code-block">
            <pre><code class="language-python"># Get all system instructions
instructions = registry.get_system_instructions()

if instructions:
    print("Combined system prompt:")
    print(instructions)

# The client uses this automatically
# when configuring tools</code></pre>
          </div>
        </div>
      </section>

      <!-- Model Tools vs User Commands -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="tools-vs-commands">Model Tools vs User Commands</h2>
          <p>
            Plugins can provide two types of capabilities:
          </p>

          <table>
            <thead>
              <tr>
                <th>Capability</th>
                <th>Invoked By</th>
                <th>Declared Via</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Model Tools</strong></td>
                <td>AI model (function calling)</td>
                <td><code>get_tool_schemas()</code></td>
              </tr>
              <tr>
                <td><strong>User Commands</strong></td>
                <td>User directly (bypasses model)</td>
                <td><code>get_user_commands()</code></td>
              </tr>
            </tbody>
          </table>

          <h3>When to Use Which?</h3>
          <ul>
            <li><strong>Model tools</strong>: When the AI should decide when to use it</li>
            <li><strong>User commands</strong>: For direct control, admin tasks, or quick actions</li>
          </ul>

          <div class="callout callout-info">
            <div class="callout-title">Who is "User"?</div>
            "User" means whoever is directly interfacing with the client — this could
            be a human operator OR another AI agent in agent-to-agent scenarios.
            User commands bypass the model's function calling and execute directly.
          </div>
        </div>
        <div class="panel-code">
          <div class="code-label">Model tools vs user commands</div>
          <div class="code-block">
            <pre><code class="language-python">class SearchPlugin:
    name = "search"

    def get_tool_schemas(self):
        # MODEL TOOLS: AI decides when to use
        return [
            ToolSchema(
                name="search_index",
                description="Search the index",
                parameters={...}
            )
        ]

    def get_user_commands(self):
        # USER COMMANDS: User invokes directly
        return [
            UserCommand(
                "search",
                "Search directly",
                share_with_model=True
            ),
            UserCommand(
                "reindex",
                "Rebuild index",
                share_with_model=False
            )
        ]</code></pre>
          </div>

          <div class="code-label" style="margin-top: 24px;">Execution flow</div>
          <div class="diagram-container" style="padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px;">
            <svg viewBox="0 0 380 280" style="width: 100%; max-width: 380px; height: auto;">
              <defs>
                <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#8b8b8b"/>
                </marker>
              </defs>

              <!-- Model Tool Flow -->
              <text x="190" y="20" text-anchor="middle" fill="#635bff" font-size="12" font-weight="600" font-family="system-ui, sans-serif">Model Tool Flow</text>

              <!-- Row 1: User -> Model -->
              <rect x="10" y="35" width="60" height="28" rx="4" fill="#3b3b4f" stroke="#5b5b6f" stroke-width="1"/>
              <text x="40" y="53" text-anchor="middle" fill="#e4e4e7" font-size="10" font-family="system-ui, sans-serif">User</text>

              <line x1="70" y1="49" x2="95" y2="49" stroke="#8b8b8b" stroke-width="1.5" marker-end="url(#arrow)"/>
              <text x="82" y="42" text-anchor="middle" fill="#7a7a8a" font-size="8" font-family="system-ui, sans-serif">"Find X"</text>

              <rect x="105" y="35" width="60" height="28" rx="4" fill="#2d2d3f" stroke="#635bff" stroke-width="1.5"/>
              <text x="135" y="53" text-anchor="middle" fill="#a5a5b5" font-size="10" font-family="system-ui, sans-serif">Model</text>

              <line x1="165" y1="49" x2="190" y2="49" stroke="#8b8b8b" stroke-width="1.5" marker-end="url(#arrow)"/>

              <rect x="200" y="35" width="80" height="28" rx="4" fill="#1e1e2e" stroke="#3b3b4f" stroke-width="1"/>
              <text x="240" y="53" text-anchor="middle" fill="#a5a5b5" font-size="9" font-family="system-ui, sans-serif">FunctionCall</text>

              <line x1="280" y1="49" x2="305" y2="49" stroke="#8b8b8b" stroke-width="1.5" marker-end="url(#arrow)"/>

              <rect x="315" y="35" width="55" height="28" rx="4" fill="#2d2d3f" stroke="#4b4b5f" stroke-width="1"/>
              <text x="342" y="53" text-anchor="middle" fill="#a5a5b5" font-size="9" font-family="system-ui, sans-serif">Executor</text>

              <!-- Row 2: Executor -> Result -> Model -> Response -->
              <line x1="342" y1="63" x2="342" y2="85" stroke="#8b8b8b" stroke-width="1.5" marker-end="url(#arrow)"/>

              <rect x="315" y="95" width="55" height="28" rx="4" fill="#1e1e2e" stroke="#3b3b4f" stroke-width="1"/>
              <text x="342" y="113" text-anchor="middle" fill="#a5a5b5" font-size="9" font-family="system-ui, sans-serif">Result</text>

              <line x1="315" y1="109" x2="175" y2="109" stroke="#8b8b8b" stroke-width="1.5" marker-end="url(#arrow)"/>

              <rect x="105" y="95" width="60" height="28" rx="4" fill="#2d2d3f" stroke="#635bff" stroke-width="1.5"/>
              <text x="135" y="113" text-anchor="middle" fill="#a5a5b5" font-size="10" font-family="system-ui, sans-serif">Model</text>

              <line x1="105" y1="109" x2="80" y2="109" stroke="#8b8b8b" stroke-width="1.5" marker-end="url(#arrow)"/>

              <rect x="10" y="95" width="60" height="28" rx="4" fill="#10b981" fill-opacity="0.15" stroke="#10b981" stroke-width="1"/>
              <text x="40" y="113" text-anchor="middle" fill="#10b981" font-size="9" font-family="system-ui, sans-serif">Response</text>

              <!-- Divider -->
              <line x1="20" y1="145" x2="360" y2="145" stroke="#3b3b4f" stroke-width="1" stroke-dasharray="4,4"/>

              <!-- User Command Flow -->
              <text x="190" y="170" text-anchor="middle" fill="#f59e0b" font-size="12" font-weight="600" font-family="system-ui, sans-serif">User Command Flow</text>

              <!-- Simple flow: User -> Executor -> Result -> User -->
              <rect x="10" y="185" width="60" height="28" rx="4" fill="#3b3b4f" stroke="#5b5b6f" stroke-width="1"/>
              <text x="40" y="203" text-anchor="middle" fill="#e4e4e7" font-size="10" font-family="system-ui, sans-serif">User</text>

              <line x1="70" y1="199" x2="115" y2="199" stroke="#8b8b8b" stroke-width="1.5" marker-end="url(#arrow)"/>
              <text x="92" y="192" text-anchor="middle" fill="#7a7a8a" font-size="8" font-family="system-ui, sans-serif">/search X</text>

              <rect x="125" y="185" width="70" height="28" rx="4" fill="#2d2d3f" stroke="#4b4b5f" stroke-width="1"/>
              <text x="160" y="203" text-anchor="middle" fill="#a5a5b5" font-size="10" font-family="system-ui, sans-serif">Executor</text>

              <line x1="195" y1="199" x2="220" y2="199" stroke="#8b8b8b" stroke-width="1.5" marker-end="url(#arrow)"/>

              <rect x="230" y="185" width="55" height="28" rx="4" fill="#1e1e2e" stroke="#3b3b4f" stroke-width="1"/>
              <text x="257" y="203" text-anchor="middle" fill="#a5a5b5" font-size="9" font-family="system-ui, sans-serif">Result</text>

              <line x1="285" y1="199" x2="310" y2="199" stroke="#8b8b8b" stroke-width="1.5" marker-end="url(#arrow)"/>

              <rect x="320" y="185" width="50" height="28" rx="4" fill="#10b981" fill-opacity="0.15" stroke="#10b981" stroke-width="1"/>
              <text x="345" y="203" text-anchor="middle" fill="#10b981" font-size="9" font-family="system-ui, sans-serif">User</text>

              <!-- Note -->
              <text x="190" y="240" text-anchor="middle" fill="#7a7a8a" font-size="10" font-style="italic" font-family="system-ui, sans-serif">(model not involved)</text>

              <!-- Model crossed out indicator -->
              <rect x="145" y="250" width="45" height="20" rx="3" fill="none" stroke="#4b4b5f" stroke-width="1" stroke-dasharray="3,2"/>
              <text x="167" y="264" text-anchor="middle" fill="#5a5a6a" font-size="9" font-family="system-ui, sans-serif">Model</text>
              <line x1="148" y1="260" x2="187" y2="260" stroke="#ef4444" stroke-width="1.5"/>
            </svg>
          </div>
        </div>
      </section>

      <!-- Dual Exposure -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="dual-exposure">Dual Exposure: Same Capability, Two Interfaces</h2>
          <p>
            Sometimes you want the same capability available both ways:
          </p>
          <ul>
            <li>As a <strong>model tool</strong> the AI can invoke</li>
            <li>As a <strong>user command</strong> for direct access</li>
          </ul>

          <h3>share_with_model</h3>
          <p>
            The <code>share_with_model</code> flag controls whether user command
            output is added to conversation history:
          </p>
          <ul>
            <li><code>True</code>: Output goes to history, model can see/use it on subsequent turns</li>
            <li><code>False</code>: Output only shown to user, model never sees it</li>
          </ul>

          <div class="callout callout-info">
            <div class="callout-title">Important: share_with_model != Tool Exposure</div>
            <p>
              The <code>share_with_model</code> flag does <strong>not</strong> expose the command
              as a tool. Tool exposure requires declaring the capability in <code>get_tool_schemas()</code>.
            </p>
            <p>
              These are independent declarations:
            </p>
            <ul>
              <li>A user command with <code>share_with_model=True</code> is <strong>not</strong> automatically a tool</li>
              <li>A tool is <strong>not</strong> automatically a user command</li>
              <li>For dual exposure, you must declare both explicitly</li>
            </ul>
            <p>
              Think of <code>share_with_model</code> as: "when the user runs this command, should the
              model know about it?" — not "should this also be a tool".
            </p>
          </div>

          <h3>Auto-Approval</h3>
          <p>
            User commands typically should be auto-approved since the user
            invokes them directly. List them in <code>get_auto_approved_tools()</code>
            to avoid unexpected permission prompts.
          </p>

          <div class="callout callout-warning">
            <div class="callout-title">Don't Forget Auto-Approval</div>
            If a user command isn't in <code>get_auto_approved_tools()</code>,
            the permission system will prompt for approval — confusing since
            the user explicitly requested it.
          </div>
        </div>
        <div class="panel-code">
          <div class="code-label">Dual exposure example</div>
          <div class="code-block">
            <pre><code class="language-python">class TodoPlugin:
    name = "todo"

    def get_tool_schemas(self):
        # Model can add/list todos
        return [
            ToolSchema(name="add_todo", ...),
            ToolSchema(name="list_todos", ...),
        ]

    def get_user_commands(self):
        # User can also do it directly
        return [
            UserCommand(
                "todo_add",
                "Add a todo",
                share_with_model=True  # Model sees what was added
            ),
            UserCommand(
                "todo_list",
                "List todos",
                share_with_model=True  # Model sees the list
            ),
            UserCommand(
                "todo_clear",
                "Clear all todos",
                share_with_model=False  # Admin only
            )
        ]

    def get_auto_approved_tools(self):
        # User commands don't need permission prompts
        return ["todo_add", "todo_list", "todo_clear"]</code></pre>
          </div>

          <div class="code-label" style="margin-top: 24px;">share_with_model in action</div>
          <div class="code-block">
            <pre><code class="language-python"># share_with_model=True:
# User: /todo_list
# → Shows list to user
# → Adds to conversation history
# → Model: "I see you have 3 pending todos..."

# share_with_model=False:
# User: /todo_clear
# → Clears todos
# → Shows "Cleared" to user
# → NOT in history, model doesn't know</code></pre>
          </div>
        </div>
      </section>

      <!-- User Commands -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="user-commands">UserCommand Reference</h2>
          <p>
            The <code>UserCommand</code> type declares a user-facing command.
          </p>

          <h3>Fields</h3>
          <ul class="param-list">
            <li>
              <span class="param-name">name</span>
              <span class="param-type">str</span>
              <div class="param-desc">Command name (e.g., "list_todos")</div>
            </li>
            <li>
              <span class="param-name">description</span>
              <span class="param-type">str</span>
              <div class="param-desc">Help text for autocomplete</div>
            </li>
            <li>
              <span class="param-name">share_with_model</span>
              <span class="param-type">bool</span>
              <div class="param-desc">Add output to conversation history (default: False)</div>
            </li>
            <li>
              <span class="param-name">parameters</span>
              <span class="param-type">List[CommandParameter]</span>
              <div class="param-desc">Optional parameter definitions</div>
            </li>
          </ul>

          <h3>CommandParameter</h3>
          <ul class="param-list">
            <li>
              <span class="param-name">name</span>
              <span class="param-type">str</span>
              <div class="param-desc">Parameter name</div>
            </li>
            <li>
              <span class="param-name">description</span>
              <span class="param-type">str</span>
              <div class="param-desc">Help text</div>
            </li>
            <li>
              <span class="param-name">required</span>
              <span class="param-type">bool</span>
              <div class="param-desc">Is this parameter required?</div>
            </li>
            <li>
              <span class="param-name">capture_rest</span>
              <span class="param-type">bool</span>
              <div class="param-desc">Capture all remaining args (last param only)</div>
            </li>
          </ul>
        </div>
        <div class="panel-code">
          <div class="code-label">Define user commands with parameters</div>
          <div class="code-block">
            <pre><code class="language-python">from shared.plugins.base import (
    UserCommand,
    CommandParameter
)

def get_user_commands(self):
    return [
        # Simple command, no parameters
        UserCommand(
            name="status",
            description="Show status"
        ),

        # Command with parameters
        UserCommand(
            name="search",
            description="Search for pattern",
            share_with_model=True,
            parameters=[
                CommandParameter(
                    name="pattern",
                    description="Search pattern",
                    required=True
                ),
                CommandParameter(
                    name="description",
                    description="Optional notes",
                    capture_rest=True  # Gets remaining args
                )
            ]
        )
    ]</code></pre>
          </div>

          <div class="code-label" style="margin-top: 24px;">Execute user commands</div>
          <div class="code-block">
            <pre><code class="language-python"># List available commands
commands = client.get_user_commands()
for name, cmd in commands.items():
    print(f"/{name}: {cmd.description}")

# Execute a command
result, share = client.execute_user_command("status")

# With arguments
result, share = client.execute_user_command(
    "search",
    args={"pattern": "TODO", "description": "Find todos"}
)</code></pre>
          </div>
        </div>
      </section>

      <!-- Model Requirements -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="model-requirements">Model Requirements</h2>
          <p>
            Some plugins only work with specific models. Use
            <code>get_model_requirements()</code> to specify required models
            using glob patterns.
          </p>

          <p>
            If the current model doesn't match, the plugin is skipped during
            discovery.
          </p>

          <h3>Pattern Examples</h3>
          <table>
            <thead>
              <tr>
                <th>Pattern</th>
                <th>Matches</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>gemini-*</code></td>
                <td>All Gemini models</td>
              </tr>
              <tr>
                <td><code>gemini-2.5-*</code></td>
                <td>Gemini 2.5 family</td>
              </tr>
              <tr>
                <td><code>*-pro</code></td>
                <td>Any "pro" model</td>
              </tr>
              <tr>
                <td><code>claude-*</code></td>
                <td>Claude models</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="panel-code">
          <div class="code-label">Model requirements</div>
          <div class="code-block">
            <pre><code class="language-python">class GeminiOnlyPlugin:
    name = "gemini_features"

    def get_model_requirements(self):
        # Only works with Gemini
        return ["gemini-*"]

    def get_tool_schemas(self):
        return [...]

# Check skipped plugins
registry = PluginRegistry(model_name="claude-3")
registry.discover()

skipped = registry.list_skipped_plugins()
for name, requirements in skipped.items():
    print(f"{name} requires: {requirements}")
# gemini_features requires: ['gemini-*']</code></pre>
          </div>
        </div>
      </section>

      <!-- Next Steps -->
      <section class="two-panel">
        <div class="panel-explanation">
          <h2 id="next-steps">Next Steps</h2>
          <ul>
            <li><a href="tools.html">Tools</a> — How tool execution works</li>
            <li><a href="../guides/tool-plugins.html">Building Plugins</a> — Step-by-step guide</li>
            <li><a href="../api-reference/plugin-registry.html">PluginRegistry API</a> — Full reference</li>
          </ul>
        </div>
        <div class="panel-code">
          <div class="code-label">Plugin directory structure</div>
          <div class="code-block">
            <pre><code class="language-python"># Built-in plugins location:
# shared/plugins/
#   ├── cli/
#   │   ├── __init__.py
#   │   └── plugin.py
#   ├── mcp/
#   │   ├── __init__.py
#   │   └── plugin.py
#   ├── file_edit/
#   ├── todo/
#   ├── web_search/
#   ├── permission/
#   ├── session/
#   ├── gc_truncate/
#   ├── gc_summarize/
#   └── model_provider/
#       ├── google_genai/
#       └── types.py</code></pre>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="https://unpkg.com/lunr@2.3.9/lunr.min.js"></script>


  <script src="../assets/js/docs.js"></script>
</body>
</html>
