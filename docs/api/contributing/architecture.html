<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Architecture - jaato docs</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
  </script>
  <style>
    .mermaid {
      background: white;
      padding: 24px;
      border-radius: 8px;
      border: 1px solid var(--color-border);
      margin: 24px 0;
    }
    .ascii-diagram {
      background: var(--color-bg-code);
      color: #e0e0e0;
      padding: 24px;
      border-radius: 8px;
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.4;
      overflow-x: auto;
      white-space: pre;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="../index.html" class="header-logo">
      jaato <span>docs</span>
    </a>
    <nav class="header-nav">
      <a href="../getting-started/quickstart.html">Quickstart</a>
      <a href="../api-reference/index.html">API Reference</a>
      <a href="https://github.com/apanoia/jaato" target="_blank">GitHub</a>
      <div class="header-search">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" placeholder="Search docs... (press /)">
      </div>
    </nav>
  </header>

  <!-- Layout -->
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Getting Started</div>
        <ul class="sidebar-nav">
          <li><a href="../getting-started/quickstart.html">Quickstart</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Core Concepts</div>
        <ul class="sidebar-nav">
          <li><a href="../core-concepts/client.html">Client</a></li>
          <li><a href="../core-concepts/plugins.html">Plugins</a></li>
          <li><a href="../core-concepts/tools.html">Tools</a></li>
          <li><a href="../core-concepts/providers.html">Providers</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Guides</div>
        <ul class="sidebar-nav">
          <li><a href="../guides/tool-plugins.html">Building Plugins</a></li>
          <li><a href="../guides/mcp-integration.html">MCP Integration</a></li>
          <li><a href="../guides/permissions.html">Permissions</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Contributing</div>
        <ul class="sidebar-nav">
          <li><a href="index.html">Getting Started</a></li>
          <li><a href="architecture.html" class="active">Architecture</a></li>
          <li><a href="code-style.html">Code Style</a></li>
          <li><a href="testing.html">Testing</a></li>
          <li><a href="pull-requests.html">Pull Requests</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">API Reference</div>
        <ul class="sidebar-nav">
          <li><a href="../api-reference/index.html">Overview</a></li>
          <li><a href="../api-reference/jaato-client.html">JaatoClient</a></li>
          <li><a href="../api-reference/plugin-registry.html">PluginRegistry</a></li>
          <li><a href="../api-reference/types.html">Types</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Provider Reference</div>
        <ul class="sidebar-nav">
          <li><a href="../api-reference/providers/index.html">Overview</a></li>
          <li><a href="../api-reference/providers/google-genai.html">Google GenAI</a></li>
        </ul>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main">
      <h1>Architecture Deep Dive</h1>
      <p class="lead">
        Understanding jaato's architecture will help you navigate the codebase
        and identify where to make changes. This guide covers the core components,
        plugin system, and execution flows.
      </p>

      <!-- High-Level Overview -->
      <section>
        <h2 id="overview">High-Level Architecture</h2>
        <p>
          At its core, jaato is a client framework that orchestrates communication between
          your application, AI models, and tool execution. Here's the layered architecture:
        </p>

        <div class="mermaid">
graph TB
    subgraph ClientLayer["Your Application Layer"]
        App["Generic Client Application<br/>(Your code that uses jaato)"]
    end

    subgraph JaatoLayer["Jaato Framework Layer"]
        subgraph JaatoClient["JaatoClient (Main Orchestrator)"]
            API["Public API:<br/>‚Ä¢ connect()<br/>‚Ä¢ configure_tools()<br/>‚Ä¢ send_message()<br/>‚Ä¢ get_history()"]
        end

        subgraph CoreComponents["Core Components"]
            TE["ToolExecutor<br/>(Runs tool functions)"]
            PR["PluginRegistry<br/>(Manages plugins)"]
            TL["TokenLedger<br/>(Token accounting)"]
        end

        subgraph PluginLayer["Plugin Layer"]
            PERM["PermissionPlugin<br/>(Access control)"]
            TOOLS["Tool Plugins<br/>(CLI, MCP, Todo, etc.)"]
        end
    end

    subgraph ProviderLayer["Provider Abstraction Layer"]
        Provider["ModelProviderPlugin<br/>(Provider-agnostic interface)"]
    end

    subgraph ExternalServices["External AI Services"]
        Google["Google GenAI<br/>(Gemini models)"]
        Anthropic["Anthropic<br/>(Claude models)"]
        Others["Others..."]
    end

    App --> API
    API --> TE
    API --> PR
    API --> TL
    TE --> PERM
    PR --> TOOLS
    TE --> TOOLS
    API --> Provider
    Provider --> Google
    Provider --> Anthropic
    Provider --> Others

    classDef clientStyle fill:#e1f5ff,stroke:#0288d1,stroke-width:2px
    classDef frameworkStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef providerStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef externalStyle fill:#e8f5e9,stroke:#388e3c,stroke-width:2px

    class App clientStyle
    class API,TE,PR,TL,PERM,TOOLS frameworkStyle
    class Provider providerStyle
    class Google,Anthropic,Others externalStyle
        </div>

        <p style="margin-top: 24px;">
          <strong>Key layers:</strong>
        </p>
        <ul>
          <li><strong>Application Layer</strong> (Blue) - Your code using jaato</li>
          <li><strong>Framework Layer</strong> (Purple) - jaato's core orchestration and plugin system</li>
          <li><strong>Provider Layer</strong> (Orange) - Abstract AI provider interface</li>
          <li><strong>External Services</strong> (Green) - AI model providers (Google, Anthropic, etc.)</li>
        </ul>
      </section>

      <!-- Component Diagram -->
      <section>
        <h2 id="components">Component Diagram</h2>
        <p>
          This diagram shows how the major components relate to each other and
          which external services they interact with.
        </p>

        <div class="mermaid">
flowchart TB
    subgraph Client["Generic Client Application"]
        App[Your Application]
    end

    subgraph Framework["JAATO Framework (shared/)"]
        JC[JaatoClient<br/>jaato_client.py]

        subgraph Core["Core Components"]
            TE[ToolExecutor<br/>ai_tool_runner.py]
            TL[TokenLedger<br/>token_accounting.py]
        end

        subgraph Plugins["Plugin System"]
            PR[PluginRegistry<br/>plugins/registry.py]

            subgraph Available["Available Plugins"]
                BG[BackgroundPlugin]
                CLI[CLIToolPlugin]
                MCP[MCPToolPlugin]
                PERM[PermissionPlugin]
                TODO[TodoPlugin]
                REFS[ReferencesPlugin]
                FEDIT[FileEditPlugin]
                SESS[SessionPlugin]
            end
        end

        MCM[MCPClientManager<br/>mcp_context_manager.py]
    end

    subgraph External["External Services"]
        VAI[Vertex AI<br/>Gemini Models]
        MCPS[MCP Servers]
        Shell[Local Shell]
    end

    App --> JC
    JC --> TE
    JC --> TL
    JC --> PR
    PR --> BG
    PR --> CLI
    PR --> MCP
    PR --> PERM
    PR --> TODO
    PR --> REFS
    PR --> FEDIT
    TE --> PERM
    TE --> BG
    BG --> CLI
    BG --> MCP
    MCP --> MCM
    MCM --> MCPS
    CLI --> Shell
    JC --> VAI
        </div>
      </section>

      <!-- Message Flow -->
      <section>
        <h2 id="message-flow">Message Flow Sequence</h2>
        <p>
          When a user sends a message, jaato orchestrates communication between
          the model and tools. Here's the typical flow:
        </p>

        <div class="mermaid">
sequenceDiagram
    participant App as Generic Client
    participant JC as JaatoClient
    participant Provider as ModelProviderPlugin
    participant TE as ToolExecutor
    participant Plugin as Tool Plugin
    participant TL as TokenLedger

    App->>JC: send_message("List files")
    JC->>Provider: send_message()
    Provider->>Provider: Model generates response

    alt Response has function_calls
        Provider-->>JC: function_call: cli_based_tool
        JC->>TE: execute("cli_based_tool", args)
        TE->>Plugin: call registered executor
        Plugin-->>TE: result
        TE-->>JC: function response
        JC->>Provider: send_tool_results()
        Provider->>Provider: Model processes result
    end

    Provider-->>JC: final text response
    JC->>TL: record token usage
    JC-->>App: "Here are the files: ..."
        </div>

        <div class="callout callout-info" style="margin-top: 24px;">
          <div class="callout-title">Function Calling Loop</div>
          <p>
            The sequence above can repeat multiple times if the model makes additional
            function calls based on previous results. JaatoClient handles this loop
            automatically until the model returns a final text response.
          </p>
        </div>
      </section>

      <!-- Plugin System -->
      <section>
        <h2 id="plugin-system">Plugin System Architecture</h2>
        <p>
          jaato has three distinct plugin systems, each serving a different purpose:
        </p>

        <h3>1. Tool Plugins</h3>
        <p>
          Managed by <code>PluginRegistry</code>, these provide tools for the model
          to call via function calling. Examples: CLI, MCP, file editing, web search.
        </p>
        <ul>
          <li><strong>Location:</strong> <code>shared/plugins/*/</code></li>
          <li><strong>Entry Point:</strong> <code>jaato.plugins</code></li>
          <li><strong>Protocol:</strong> <code>ToolPlugin</code></li>
          <li><strong>Key Methods:</strong> <code>get_tool_schemas()</code>, <code>get_executors()</code></li>
        </ul>

        <h3>2. GC (Garbage Collection) Plugins</h3>
        <p>
          Manage context window overflow by removing or summarizing old conversation
          turns. Strategies: truncate, summarize, hybrid.
        </p>
        <ul>
          <li><strong>Location:</strong> <code>shared/plugins/gc_*/</code></li>
          <li><strong>Entry Point:</strong> <code>jaato.gc_plugins</code></li>
          <li><strong>Protocol:</strong> <code>GCPlugin</code></li>
          <li><strong>Key Methods:</strong> <code>should_collect()</code>, <code>collect()</code></li>
        </ul>

        <h3>3. Model Provider Plugins</h3>
        <p>
          Abstract AI provider SDKs to provide a uniform interface. Currently supports
          Google GenAI/Vertex AI. Anthropic support coming soon.
        </p>
        <ul>
          <li><strong>Location:</strong> <code>shared/plugins/model_provider/*/</code></li>
          <li><strong>Entry Point:</strong> <code>jaato.model_providers</code></li>
          <li><strong>Protocol:</strong> <code>ModelProviderPlugin</code></li>
          <li><strong>Key Methods:</strong> <code>connect()</code>, <code>send_message()</code>, <code>get_history()</code></li>
        </ul>
      </section>

      <!-- File Structure -->
      <section>
        <h2 id="file-structure">File Structure</h2>
        <p>
          Understanding where code lives will help you navigate the codebase:
        </p>

        <div class="code-block">
          <pre><code class="language-bash">jaato/
‚îú‚îÄ‚îÄ shared/                     # Core framework (internal)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py             # Package exports
‚îÇ   ‚îú‚îÄ‚îÄ jaato_client.py         # JaatoClient - main orchestrator
‚îÇ   ‚îú‚îÄ‚îÄ ai_tool_runner.py       # ToolExecutor - function loop
‚îÇ   ‚îú‚îÄ‚îÄ token_accounting.py     # TokenLedger - usage tracking
‚îÇ   ‚îú‚îÄ‚îÄ mcp_context_manager.py  # MCP server connections
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ plugins/                # Plugin system
‚îÇ       ‚îú‚îÄ‚îÄ base.py             # ToolPlugin protocol
‚îÇ       ‚îú‚îÄ‚îÄ registry.py         # PluginRegistry
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ model_provider/     # Provider abstraction
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ base.py         # ModelProviderPlugin protocol
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ types.py        # Provider-agnostic types
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ google_genai/   # Google GenAI implementation
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ cli/                # CLI tool plugin
‚îÇ       ‚îú‚îÄ‚îÄ mcp/                # MCP integration
‚îÇ       ‚îú‚îÄ‚îÄ permission/         # Permission control
‚îÇ       ‚îú‚îÄ‚îÄ todo/               # Task planning
‚îÇ       ‚îú‚îÄ‚îÄ file_edit/          # File operations
‚îÇ       ‚îú‚îÄ‚îÄ web_search/         # DuckDuckGo search
‚îÇ       ‚îú‚îÄ‚îÄ session/            # Session persistence
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ gc_truncate/        # GC: truncation strategy
‚îÇ       ‚îú‚îÄ‚îÄ gc_summarize/       # GC: summarization strategy
‚îÇ       ‚îî‚îÄ‚îÄ gc_hybrid/          # GC: hybrid strategy
‚îÇ
‚îú‚îÄ‚îÄ jaato/                      # Public API (for external use)
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py             # Re-exports from shared/
‚îÇ
‚îú‚îÄ‚îÄ simple-client/              # Reference implementation
‚îÇ   ‚îî‚îÄ‚îÄ interactive_client.py   # Interactive CLI client
‚îÇ
‚îî‚îÄ‚îÄ docs/                       # Documentation
    ‚îú‚îÄ‚îÄ api/                    # HTML API docs (this site)
    ‚îî‚îÄ‚îÄ architecture.md         # Architecture markdown</code></pre>
        </div>
      </section>

      <!-- UI Hooks System -->
      <section>
        <h2 id="ui-hooks">UI Hooks System</h2>
        <p>
          The framework provides a UI hooks system (<code>AgentUIHooks</code> protocol) that enables
          rich terminal UIs to integrate with agent execution. This provides visibility into agent
          lifecycle, tool execution, and accounting.
        </p>

        <h3>Key Hooks</h3>
        <table>
          <thead>
            <tr>
              <th>Hook</th>
              <th>When Called</th>
              <th>Purpose</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>on_agent_status_changed</code></td>
              <td>Status change</td>
              <td>Start/stop spinner ("active", "done", "error")</td>
            </tr>
            <tr>
              <td><code>on_tool_call_start</code></td>
              <td>Tool begins</td>
              <td>Show active tool below spinner</td>
            </tr>
            <tr>
              <td><code>on_tool_call_end</code></td>
              <td>Tool completes</td>
              <td>Remove tool from display</td>
            </tr>
            <tr>
              <td><code>on_agent_output</code></td>
              <td>Any output</td>
              <td>Route to agent's output buffer</td>
            </tr>
            <tr>
              <td><code>on_agent_turn_completed</code></td>
              <td>Turn ends</td>
              <td>Update per-turn accounting</td>
            </tr>
          </tbody>
        </table>

        <h3>Tool Call Visualization</h3>
        <p>
          The <code>on_tool_call_start</code> and <code>on_tool_call_end</code> hooks enable real-time
          visualization of active tool calls. When a tool is executing, the UI can show it below the spinner:
        </p>
        <div class="code-block">
          <pre><code>Model> ‚†ã thinking...
       ‚îú‚îÄ cli_execute({'cmd': 'ls -la'})
       ‚îî‚îÄ web_search({'query': 'python docs'})</code></pre>
        </div>
        <p>
          These hooks are emitted automatically for <strong>all plugins</strong> from
          <code>JaatoSession._run_chat_loop()</code>. No plugin-specific changes are required.
        </p>

        <h3>Hook Propagation</h3>
        <p>Hooks are set at multiple levels:</p>
        <ul>
          <li><code>JaatoClient.set_ui_hooks(hooks)</code> - Main agent, passes to session</li>
          <li><code>JaatoSession.set_ui_hooks(hooks, agent_id)</code> - Tool lifecycle emission</li>
          <li><code>SubagentPlugin.set_ui_hooks(hooks)</code> - Passes to spawned sessions</li>
        </ul>
        <p>
          See <a href="../subagent_ui_hooks.html">Subagent UI Hooks API</a> for complete documentation.
        </p>
      </section>

      <!-- Key Abstractions -->
      <section>
        <h2 id="abstractions">Key Abstractions</h2>

        <h3>Provider-Agnostic Types</h3>
        <p>
          To support multiple AI providers, jaato defines its own types in
          <code>shared/plugins/model_provider/types.py</code>:
        </p>
        <ul>
          <li><code>ToolSchema</code> - Function declaration (replaces SDK-specific types)</li>
          <li><code>Message</code> - Conversation message with role and parts</li>
          <li><code>Part</code> - Message content (text, function_call, function_response)</li>
          <li><code>ProviderResponse</code> - Unified response from any provider</li>
        </ul>

        <h3>Plugin Discovery</h3>
        <p>
          Plugins register via Python entry points in <code>pyproject.toml</code>:
        </p>
        <div class="code-block">
          <pre><code class="language-toml">[project.entry-points."jaato.plugins"]
cli = "shared.plugins.cli:create_plugin"
mcp = "shared.plugins.mcp:create_plugin"
todo = "shared.plugins.todo:create_plugin"

[project.entry-points."jaato.gc_plugins"]
gc_truncate = "shared.plugins.gc_truncate:create_plugin"
gc_summarize = "shared.plugins.gc_summarize:create_plugin"</code></pre>
        </div>

        <h3>User Commands vs Model Tools</h3>
        <p>
          Plugins can provide two types of capabilities:
        </p>
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Invoked By</th>
              <th>History</th>
              <th>Example</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Model Tools</strong></td>
              <td>AI via function calling</td>
              <td>Always in history</td>
              <td><code>cli_execute</code>, <code>web_search</code></td>
            </tr>
            <tr>
              <td><strong>User Commands</strong></td>
              <td>User types directly</td>
              <td>Configurable</td>
              <td><code>plan</code>, <code>sessions</code></td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Next Steps -->
      <section style="padding: 40px 0;">
        <h2>Related Pages</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 24px;">
          <a href="index.html" style="display: block; padding: 20px; border: 1px solid var(--color-border); border-radius: 8px; text-decoration: none;">
            <h3 style="margin-top: 0;">üèÅ Getting Started</h3>
            <p style="color: var(--color-text-secondary); margin: 0; font-size: 14px;">
              Set up your development environment and run tests.
            </p>
          </a>

          <a href="../core-concepts/plugins.html" style="display: block; padding: 20px; border: 1px solid var(--color-border); border-radius: 8px; text-decoration: none;">
            <h3 style="margin-top: 0;">üîå Plugin Concepts</h3>
            <p style="color: var(--color-text-secondary); margin: 0; font-size: 14px;">
              Learn how the plugin system works from a user perspective.
            </p>
          </a>

          <a href="../guides/tool-plugins.html" style="display: block; padding: 20px; border: 1px solid var(--color-border); border-radius: 8px; text-decoration: none;">
            <h3 style="margin-top: 0;">üõ†Ô∏è Building Plugins</h3>
            <p style="color: var(--color-text-secondary); margin: 0; font-size: 14px;">
              Step-by-step guide to creating your own tool plugin.
            </p>
          </a>

          <a href="../../architecture.md" style="display: block; padding: 20px; border: 1px solid var(--color-border); border-radius: 8px; text-decoration: none;">
            <h3 style="margin-top: 0;">üìÑ Full Architecture Doc</h3>
            <p style="color: var(--color-text-secondary); margin: 0; font-size: 14px;">
              Complete architecture markdown with all diagrams and details.
            </p>
          </a>
        </div>
      </section>
    </main>
  </div>

  <script src="https://unpkg.com/lunr@2.3.9/lunr.min.js"></script>
  <script src="../assets/js/docs.js"></script>
</body>
</html>
